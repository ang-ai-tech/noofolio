{% extends "base.html" %}

{% block content %}
<!-- Full-Screen Portfolio -->
<div style="margin: -2rem; margin-top: 0;">
    <iframe srcdoc="{{ portfolio_html | replace('\"', '&quot;') }}"
            style="width: 100%; height: calc(100vh - 60px); border: none;">
    </iframe>
</div>

<!-- Floating NooMe Chat Widget -->
<div id="chat-widget" style="position: fixed; bottom: 30px; right: 30px; z-index: 2000;">
    <!-- Chat Button (when closed) -->
    <button id="chat-toggle" onclick="toggleChat()" style="
        min-width: 320px;
        padding: 1.25rem 1.75rem;
        border-radius: 16px;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        border: none;
        cursor: pointer;
        box-shadow: 0 8px 24px rgba(99, 102, 241, 0.5), 0 0 0 0 rgba(99, 102, 241, 0.4);
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
        transition: all 0.3s ease;
        animation: pulse-glow 2s ease-in-out infinite;
    " onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 32px rgba(99, 102, 241, 0.6)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 24px rgba(99, 102, 241, 0.5)'">
        <div style="display: flex; align-items: center; gap: 0.75rem; width: 100%;">
            <span style="font-size: 2rem;">üß†</span>
            <div style="flex: 1; text-align: left;">
                <div style="font-weight: 700; font-size: 1.1rem; color: #fff; margin-bottom: 0.25rem;">
                    Chatta con {{ profile_name }}
                </div>
                <div style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.9); font-weight: 400;">
                    Clicca e inizia a chattare con l'alterego digitale
                </div>
            </div>
        </div>
        <div style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.7); font-style: italic; margin-top: 0.25rem;">
            üí¨ Puoi chiedermi quello che chiederesti a {{ profile_name }}
        </div>
    </button>

    <!-- Chat Window (hidden by default) -->
    <div id="chat-window" style="display: none; position: absolute; bottom: 80px; right: 0; width: 400px; max-width: 90vw; background: var(--bg-card); border: 2px solid var(--primary); border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.5);">
        <!-- Header -->
        <div style="padding: 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(34, 211, 238, 0.15)); border-radius: 14px 14px 0 0;">
            <div>
                <h4 style="margin: 0; color: var(--accent); font-size: 1rem;">üß† NooMe</h4>
                <p style="margin: 0; font-size: 0.75rem; color: var(--text-dim);">Clone di {{ profile_name }}</p>
            </div>
            <button onclick="toggleChat()" style="background: none; border: none; color: var(--text); font-size: 1.5rem; cursor: pointer; padding: 0; width: 30px; height: 30px;">√ó</button>
        </div>

        <!-- Messages -->
        <div id="chat-messages" style="
            padding: 1rem;
            height: 400px;
            overflow-y: auto;
            background: var(--bg-dark);
        ">
            <div class="chat-message assistant" style="margin-bottom: 1rem;">
                <strong style="color: var(--accent); font-size: 0.9rem;">NooMe:</strong>
                <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: var(--text);">Ciao! Sono il clone di {{ profile_name }}. Come posso aiutarti?</p>
            </div>
        </div>

        <!-- Input -->
        <form id="chat-form" style="padding: 1rem; border-top: 1px solid var(--border); display: flex; gap: 0.5rem;">
            <input type="text"
                   id="chat-input"
                   placeholder="Scrivi a NooMe..."
                   style="flex: 1; padding: 0.75rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.9rem;">
            <button type="submit" class="btn btn-primary" style="padding: 0.75rem 1.25rem; font-size: 0.9rem;">Invia</button>
        </form>
    </div>
</div>

<style>
.chat-message {
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    border-radius: 8px;
    position: relative;
}

.chat-message.user {
    background: rgba(99, 102, 241, 0.1);
    border-left: 3px solid var(--primary);
}

.chat-message.assistant {
    background: rgba(34, 211, 238, 0.1);
    border-left: 3px solid var(--accent);
}

.feedback-buttons {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--border);
}

.feedback-btn {
    padding: 0.25rem 0.5rem;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 0.75rem;
    transition: all 0.2s;
}

.feedback-btn:hover {
    background: var(--primary);
    color: var(--text);
    border-color: var(--primary);
}

.feedback-btn.positive:hover {
    background: var(--accent-green);
    border-color: var(--accent-green);
}

.feedback-btn.negative:hover {
    background: var(--accent-red);
    border-color: var(--accent-red);
}

/* Scrollbar styling */
#chat-messages::-webkit-scrollbar {
    width: 6px;
}

#chat-messages::-webkit-scrollbar-track {
    background: var(--bg-card);
}

#chat-messages::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 3px;
}

#chat-messages::-webkit-scrollbar-thumb:hover {
    background: var(--primary);
}

/* Chat toggle button animation */
@keyframes pulse-glow {
    0%, 100% {
        box-shadow: 0 8px 24px rgba(99, 102, 241, 0.5), 0 0 0 0 rgba(99, 102, 241, 0.4);
    }
    50% {
        box-shadow: 0 8px 24px rgba(99, 102, 241, 0.5), 0 0 0 8px rgba(99, 102, 241, 0);
    }
}

/* Responsive chat toggle */
@media (max-width: 768px) {
    #chat-toggle {
        min-width: 280px !important;
        padding: 1rem 1.25rem !important;
        font-size: 0.9rem !important;
    }

    #chat-toggle > div:first-child > span {
        font-size: 1.5rem !important;
    }

    #chat-toggle > div:first-child > div > div:first-child {
        font-size: 1rem !important;
    }

    #chat-toggle > div:first-child > div > div:nth-child(2) {
        font-size: 0.75rem !important;
    }

    #chat-toggle > div:nth-child(2) {
        font-size: 0.7rem !important;
    }
}
</style>

<script>
const chatForm = document.getElementById('chat-form');
const chatInput = document.getElementById('chat-input');
const chatMessages = document.getElementById('chat-messages');
let messageCount = 0;

function toggleChat() {
    const chatWindow = document.getElementById('chat-window');
    const chatToggle = document.getElementById('chat-toggle');

    if (chatWindow.style.display === 'none') {
        chatWindow.style.display = 'block';
        chatToggle.style.display = 'none';
    } else {
        chatWindow.style.display = 'none';
        chatToggle.style.display = 'flex';
    }
}

function addFeedbackButtons(messageElement, messageId) {
    const feedbackDiv = document.createElement('div');
    feedbackDiv.className = 'feedback-buttons';
    feedbackDiv.innerHTML = `
        <button class="feedback-btn positive" onclick="sendFeedback(${messageId}, 'helpful')">üëç Utile</button>
        <button class="feedback-btn negative" onclick="sendFeedback(${messageId}, 'not_helpful')">üëé Non utile</button>
        <button class="feedback-btn negative" onclick="sendFeedback(${messageId}, 'incorrect')">‚ö†Ô∏è Incorretta</button>
    `;
    messageElement.appendChild(feedbackDiv);
}

async function sendFeedback(messageId, feedbackType) {
    try {
        await fetch('/api/chat-feedback/{{ profile_id }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                message_id: messageId,
                feedback: feedbackType
            })
        });

        // Show confirmation
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = '‚úì Grazie!';
        btn.disabled = true;
        setTimeout(() => {
            btn.textContent = originalText;
        }, 2000);
    } catch (error) {
        console.error('Feedback error:', error);
    }
}

chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const message = chatInput.value.trim();
    if (!message) return;

    // Add user message
    const userMsg = document.createElement('div');
    userMsg.className = 'chat-message user';
    userMsg.innerHTML = `<strong style="color: var(--primary); font-size: 0.9rem;">Tu:</strong><p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: var(--text);">${message}</p>`;
    chatMessages.appendChild(userMsg);

    // Clear input
    chatInput.value = '';

    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;

    // Show loading
    const loadingMsg = document.createElement('div');
    loadingMsg.className = 'chat-message assistant';
    loadingMsg.innerHTML = `<strong style="color: var(--accent); font-size: 0.9rem;">NooMe:</strong><p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: var(--text-muted);">Sto pensando...</p>`;
    chatMessages.appendChild(loadingMsg);
    chatMessages.scrollTop = chatMessages.scrollHeight;

    // Send to API
    try {
        const response = await fetch('/api/chat/{{ profile_id }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({message: message})
        });

        const data = await response.json();

        // Remove loading
        loadingMsg.remove();

        if (data.success) {
            messageCount++;
            const assistantMsg = document.createElement('div');
            assistantMsg.className = 'chat-message assistant';
            assistantMsg.innerHTML = `<strong style="color: var(--accent); font-size: 0.9rem;">NooMe:</strong><p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: var(--text);">${data.response}</p>`;
            chatMessages.appendChild(assistantMsg);

            // Add feedback buttons for visitor
            addFeedbackButtons(assistantMsg, messageCount);
        } else {
            const errorMsg = document.createElement('div');
            errorMsg.className = 'chat-message assistant';
            errorMsg.innerHTML = `<strong style="color: var(--accent-red); font-size: 0.9rem;">Errore:</strong><p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: var(--text);">${data.error}</p>`;
            chatMessages.appendChild(errorMsg);
        }
    } catch (error) {
        loadingMsg.remove();
        const errorMsg = document.createElement('div');
        errorMsg.className = 'chat-message assistant';
        errorMsg.innerHTML = `<strong style="color: var(--accent-red); font-size: 0.9rem;">Errore:</strong><p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: var(--text);">Errore di rete</p>`;
        chatMessages.appendChild(errorMsg);
    }

    chatMessages.scrollTop = chatMessages.scrollHeight;
});
</script>
{% endblock %}
