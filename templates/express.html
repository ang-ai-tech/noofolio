{% extends "base.html" %}

{% block content %}
<div class="step-container">
    <div style="text-align: center; margin-bottom: 2rem;">
        <h1 style="font-family: 'Playfair Display', serif; font-size: 2rem; color: #fff;">
            üöÄ Express Mode
        </h1>
        <p style="color: var(--text-muted);">5 domande essenziali per un Noofolio rapido</p>
    </div>

    <form id="express-form" enctype="multipart/form-data">
        <!-- 1. Identit√† -->
        <div class="form-group">
            <label>1Ô∏è‚É£ Chi sei? *</label>
            <div class="form-row">
                <input type="text" name="nome" placeholder="Nome" required>
                <input type="text" name="cognome" placeholder="Cognome" required>
            </div>
        </div>

        <!-- 2. CV Quick -->
        <div class="form-group">
            <label>2Ô∏è‚É£ Il tuo background *</label>
            <div class="cv-options" style="margin-top: 0.5rem;">
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="radio" name="cv_type" value="text" checked onchange="toggleExpressCVInput('text')">
                        <span>Scrivi (3 righe)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="radio" name="cv_type" value="upload" onchange="toggleExpressCVInput('upload')">
                        <span>Allega CV (PDF/Word)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="radio" name="cv_type" value="link" onchange="toggleExpressCVInput('link')">
                        <span>Link CV</span>
                    </label>
                </div>

                <div id="express-cv-text" style="display: block;">
                    <textarea name="cv_content" rows="4"
                              placeholder="Ruolo attuale, anni di esperienza, specializzazione principale..."></textarea>
                </div>

                <div id="express-cv-upload" style="display: none;">
                    <input type="file" name="cv_file" accept=".pdf,.doc,.docx"
                           style="padding: 0.5rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text); width: 100%;">
                </div>

                <div id="express-cv-link" style="display: none;">
                    <input type="url" name="cv_link" placeholder="https://drive.google.com/... o altro link"
                           style="width: 100%; padding: 0.75rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text);">
                </div>
            </div>
        </div>

        <!-- 3. Superpotere -->
        <div class="form-group">
            <label>3Ô∏è‚É£ Il tuo superpotere professionale *</label>
            <textarea name="superpotere" rows="3" required 
                      placeholder="Quella cosa che fai meglio di chiunque altro..."></textarea>
        </div>

        <!-- 4. Una decisione chiave -->
        <div class="form-group">
            <label>4Ô∏è‚É£ Una decisione che ti ha formato *</label>
            <textarea name="key_decision" rows="4" required 
                      placeholder="Racconta una scelta difficile e cosa hai imparato..."></textarea>
        </div>

        <!-- 5. Human vs AI -->
        <div class="form-group">
            <label>5Ô∏è‚É£ Cosa fai che l'AI non pu√≤ fare? *</label>
            <textarea name="human_delta" rows="4" required 
                      placeholder="Dove sei insostituibile rispetto all'AI..."></textarea>
        </div>

        <!-- Links (opzionali) -->
        <div class="form-group">
            <label>üîó Link professionali (opzionali)</label>
            <p class="form-help">LinkedIn, GitHub, Portfolio, ecc.</p>

            <div id="express-links-container">
                <div class="link-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <input type="url" name="link_url[]" placeholder="https://linkedin.com/in/..."
                           style="flex: 2; padding: 0.75rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text);">
                    <select name="link_type[]"
                            style="flex: 1; padding: 0.75rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text);">
                        <option value="LinkedIn">LinkedIn</option>
                        <option value="GitHub">GitHub</option>
                        <option value="Behance">Behance</option>
                        <option value="Portfolio">Portfolio</option>
                        <option value="Altro">Altro</option>
                    </select>
                    <button type="button" onclick="removeExpressLink(this)" class="btn-icon" style="padding: 0.75rem; background: var(--accent-red); color: white; border: none; border-radius: 8px; cursor: pointer;">‚úï</button>
                </div>
            </div>

            <button type="button" onclick="addExpressLink()" class="btn btn-secondary" style="margin-top: 0.5rem; font-size: 0.9rem; padding: 0.5rem 1rem;">
                ‚ûï Aggiungi link
            </button>
        </div>

        <div class="encouragement-box">
            <h4>‚ö° Quasi fatto!</h4>
            <p>Queste 5 risposte genereranno un Noofolio base. Potrai sempre arricchirlo dopo.</p>
        </div>

        <div class="form-actions">
            <a href="/onboarding" class="btn btn-secondary">‚Üê Indietro</a>
            <button type="submit" class="btn btn-primary" id="submit-btn">üöÄ Genera Noofolio Express</button>
        </div>
    </form>

    <div id="result" style="margin-top: 2rem;"></div>
</div>

<script>
function toggleExpressCVInput(type) {
    document.getElementById('express-cv-text').style.display = type === 'text' ? 'block' : 'none';
    document.getElementById('express-cv-upload').style.display = type === 'upload' ? 'block' : 'none';
    document.getElementById('express-cv-link').style.display = type === 'link' ? 'block' : 'none';
}

function addExpressLink() {
    const container = document.getElementById('express-links-container');
    const newRow = document.createElement('div');
    newRow.className = 'link-row';
    newRow.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
    newRow.innerHTML = `
        <input type="url" name="link_url[]" placeholder="https://..."
               style="flex: 2; padding: 0.75rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text);">
        <select name="link_type[]"
                style="flex: 1; padding: 0.75rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text);">
            <option value="LinkedIn">LinkedIn</option>
            <option value="GitHub">GitHub</option>
            <option value="Behance">Behance</option>
            <option value="Portfolio">Portfolio</option>
            <option value="Altro">Altro</option>
        </select>
        <button type="button" onclick="removeExpressLink(this)" class="btn-icon" style="padding: 0.75rem; background: var(--accent-red); color: white; border: none; border-radius: 8px; cursor: pointer;">‚úï</button>
    `;
    container.appendChild(newRow);
}

function removeExpressLink(button) {
    button.parentElement.remove();
}

// ========================================
// GESTIONE FORM SUBMIT CON REDIRECT
// ========================================
document.getElementById('express-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submit-btn');
    const resultDiv = document.getElementById('result');
    
    // Disable submit button
    submitBtn.disabled = true;
    submitBtn.innerHTML = '‚è≥ Generazione in corso...';
    
    // Show loading message
    resultDiv.innerHTML = `
        <div style="text-align: center; padding: 2rem; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border);">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üöÄ</div>
            <h3 style="color: var(--primary-light); margin-bottom: 1rem;">Generazione Noofolio Express...</h3>
            <p style="color: var(--text-muted);">Sto analizzando le tue risposte e creando il tuo portfolio personalizzato.</p>
            <div style="margin-top: 1.5rem;">
                <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
            </div>
        </div>
    `;
    
    try {
        // Create FormData
        const formData = new FormData(this);
        
        // Send request
        const response = await fetch('/api/generate-express', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Success! Show success message and redirect
            resultDiv.innerHTML = `
                <div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(99, 102, 241, 0.1)); border-radius: 12px; border: 2px solid var(--accent-green);">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">‚úÖ</div>
                    <h3 style="color: var(--accent-green); margin-bottom: 1rem;">Noofolio creato con successo!</h3>
                    <p style="color: var(--text); margin-bottom: 0.5rem;">Archetipo rilevato: <strong>${data.archetype.archetype_name}</strong></p>
                    <p style="color: var(--text-muted); margin-bottom: 1.5rem;">${data.archetype.combo_display}</p>
                    <p style="color: var(--text-muted);">Reindirizzamento alla pagina risultati...</p>
                </div>
            `;
            
            // Update logged user
            const userName = data.archetype.combo_display.split(' = ')[0];
            sessionStorage.setItem('current_user', userName);
            sessionStorage.setItem('current_user_id', data.profile_id);
            
            // Trigger navbar update
            window.dispatchEvent(new CustomEvent('userChanged', {
                detail: {
                    userName: userName,
                    userId: data.profile_id
                }
            }));
            
            // Redirect after 2 seconds
            setTimeout(() => {
                window.location.href = data.redirect || `/result/${data.profile_id}`;
            }, 2000);
            
        } else {
            // Error
            resultDiv.innerHTML = `
                <div style="padding: 2rem; background: rgba(239, 68, 68, 0.1); border-radius: 12px; border: 2px solid var(--accent-red);">
                    <h3 style="color: var(--accent-red); margin-bottom: 1rem;">‚ùå Errore nella generazione</h3>
                    <p style="color: var(--text);">${data.error || 'Si √® verificato un errore sconosciuto'}</p>
                </div>
            `;
            
            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'üöÄ Genera Noofolio Express';
        }
        
    } catch (error) {
        // Network or parse error
        resultDiv.innerHTML = `
            <div style="padding: 2rem; background: rgba(239, 68, 68, 0.1); border-radius: 12px; border: 2px solid var(--accent-red);">
                <h3 style="color: var(--accent-red); margin-bottom: 1rem;">‚ùå Errore di connessione</h3>
                <p style="color: var(--text);">${error.message}</p>
            </div>
        `;
        
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'üöÄ Genera Noofolio Express';
    }
});
</script>

<style>
@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}