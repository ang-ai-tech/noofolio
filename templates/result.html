{% extends "base.html" %}

{% block content %}
<div class="section">
    <div class="status-box" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(99, 102, 241, 0.1)); border-color: var(--accent-green);">
        <h2 style="color: var(--accent-green); margin-bottom: 0.5rem;">âœ… Noofolio pronto!</h2>
        <p style="font-size: 1.1rem; color: var(--text);">
            <strong>{{ archetype.get('combo_display', archetype.get('combo', '')) }}</strong>
        </p>
    </div>

    <!-- Mind Sculptor CTA -->
    <div class="encouragement-box" style="margin-top: 2rem; background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(34, 211, 238, 0.15)); border: 2px solid var(--primary);">
        <div style="text-align: center;">
            <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">ğŸ§ âœ¨</div>
            <h3 style="color: var(--primary-light); margin-bottom: 0.75rem;">Vuoi migliorare il tuo NooMe?</h3>
            <p style="margin-bottom: 1.5rem; color: var(--text-muted);">
                Rispondi ad alcune domande casuali generate dall'AI per rendere il tuo chatbot ancora piÃ¹ accurato e affidabile.
            </p>
            <a href="/mind-sculptor/{{ profile_id }}?from_creation=true" class="btn btn-primary" style="padding: 1rem 2rem; font-size: 1.1rem;">
                ğŸ¯ Inizia Mind Sculptor
            </a>
            <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-dim);">
                â­ï¸ Puoi anche saltare e farlo dopo
            </p>
        </div>
    </div>
</div>

<!-- Tabs -->
<div class="section">
    <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 2rem;">
        <button class="btn btn-primary" onclick="showTab('preview')">ğŸ‘ï¸ Preview</button>
        <button class="btn btn-secondary" onclick="showTab('download')">ğŸ“¥ Download</button>
    </div>
    
    <!-- Preview Tab -->
    <div id="preview-tab" style="display: block;">
        <iframe srcdoc="{{ portfolio_html | replace('\"', '&quot;') }}" 
                style="width: 100%; height: 700px; border: 1px solid var(--border); border-radius: 12px;">
        </iframe>
    </div>
    
    <!-- Download Tab -->
    <div id="download-tab" style="display: none; max-width: 600px; margin: 0 auto;">
        <div class="encouragement-box">
            <h4>ğŸ“¦ Download il tuo Noofolio</h4>
            <p>Scarica HTML e JSON del tuo portfolio.</p>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
            <a href="/static/downloads/{{ profile_id }}.html" download class="btn btn-primary" style="text-align: center;">
                ğŸ“„ HTML
            </a>
            <a href="/static/downloads/{{ profile_id }}.json" download class="btn btn-primary" style="text-align: center;">
                ğŸ“Š JSON
            </a>
        </div>
        
        <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem;">
            <h4 style="margin-bottom: 1rem; color: var(--text);">JSON Data Preview</h4>
            <pre style="background: var(--bg-dark); padding: 1rem; border-radius: 8px; overflow-x: auto; max-height: 400px; font-size: 0.85rem; color: var(--text-muted);">{{ portfolio_json }}</pre>
        </div>
    </div>
    
    <!-- Actions -->
    <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem; flex-wrap: wrap;">
        <a href="/create" class="btn btn-secondary">â† Modifica</a>
        <button onclick="regenerate()" class="btn btn-secondary">ğŸ”„ Rigenera</button>
        <a href="/" class="btn btn-secondary">ğŸ  Home</a>
        <a href="/view/{{ profile_id }}" class="btn btn-primary">ğŸ‘ï¸ Visualizza con NooMe</a>
    </div>
</div>

<script>
// Update logged user after portfolio creation
document.addEventListener('DOMContentLoaded', function() {
    const profileId = '{{ profile_id }}';
    const archetype = {{ archetype | tojson }};

    // Extract name from archetype or profile_id
    const userName = archetype.combo_display || profileId.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

    // Update session storage
    sessionStorage.setItem('current_user', userName);
    sessionStorage.setItem('current_user_id', profileId);

    // Trigger navbar update
    window.dispatchEvent(new CustomEvent('userChanged', {
        detail: {
            userName: userName,
            userId: profileId
        }
    }));
});

function showTab(tab) {
    document.getElementById('preview-tab').style.display = tab === 'preview' ? 'block' : 'none';
    document.getElementById('download-tab').style.display = tab === 'download' ? 'block' : 'none';
}

function regenerate() {
    if (confirm('Rigenerare il portfolio? (Questo sovrascriverÃ  quello esistente)')) {
        window.location.href = '/create';
    }
}
</script>
{% endblock %}