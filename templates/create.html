{% if not request.headers.get('HX-Request') %}
{% extends "base.html" %}
{% endif %}

{% block extra_head %}
<style>
.creation-layout {
    display: flex;
    gap: 0;
    min-height: calc(100vh - 80px);
    margin: -2rem;
    margin-top: 0;
}

.step-sidebar {
    width: 280px;
    background: linear-gradient(180deg, rgba(99, 102, 241, 0.1) 0%, rgba(34, 211, 238, 0.05) 100%);
    border-right: 1px solid var(--border);
    padding: 2rem 1.5rem;
    position: sticky;
    top: 0;
    height: calc(100vh - 80px);
    overflow-y: auto;
}

.step-sidebar-title {
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-dim);
    margin-bottom: 1.5rem;
    font-weight: 600;
}

.step-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.step-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem 1rem;
    margin-bottom: 0.5rem;
    border-radius: 8px;
    transition: all 0.2s;
    position: relative;
}

.step-item.completed {
    background: rgba(34, 197, 94, 0.1);
    border-left: 3px solid var(--accent-green);
}

.step-item.active {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(34, 211, 238, 0.15));
    border-left: 3px solid var(--primary);
}

.step-item.pending {
    opacity: 0.5;
}

.step-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: var(--bg-card);
    border: 2px solid var(--border);
    font-size: 0.85rem;
    font-weight: 600;
    flex-shrink: 0;
}

.step-item.completed .step-number {
    background: var(--accent-green);
    border-color: var(--accent-green);
    color: white;
}

.step-item.active .step-number {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.step-info {
    flex: 1;
}

.step-title {
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text);
    margin-bottom: 0.25rem;
}

.step-description {
    font-size: 0.75rem;
    color: var(--text-dim);
}

.step-content {
    flex: 1;
    padding: 2rem 3rem;
    overflow-y: auto;
    max-width: 900px;
}

@media (max-width: 1024px) {
    .step-sidebar {
        width: 200px;
        padding: 1.5rem 1rem;
    }
    .step-content {
        padding: 2rem 1.5rem;
    }
}

@media (max-width: 768px) {
    .creation-layout {
        flex-direction: column;
    }
    .step-sidebar {
        width: 100%;
        height: auto;
        position: relative;
        border-right: none;
        border-bottom: 1px solid var(--border);
    }
    .step-content {
        padding: 1.5rem 1rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="creation-layout">
    <!-- Step Sidebar -->
    <aside class="step-sidebar">
        <h3 class="step-sidebar-title">Creazione Noofolio</h3>
        <ul class="step-list">
            <li class="step-item {% if step == 1 %}active{% elif step > 1 %}completed{% else %}pending{% endif %}">
                <span class="step-number">{% if step > 1 %}âœ“{% else %}1{% endif %}</span>
                <div class="step-info">
                    <div class="step-title">Chi Sei</div>
                    <div class="step-description">Nome, CV, Links</div>
                </div>
            </li>
            <li class="step-item {% if step == 2 %}active{% elif step > 2 %}completed{% else %}pending{% endif %}">
                <span class="step-number">{% if step > 2 %}âœ“{% else %}2{% endif %}</span>
                <div class="step-info">
                    <div class="step-title">Decision Log</div>
                    <div class="step-description">Scelte chiave</div>
                </div>
            </li>
            <li class="step-item {% if step == 3 %}active{% elif step > 3 %}completed{% else %}pending{% endif %}">
                <span class="step-number">{% if step > 3 %}âœ“{% else %}3{% endif %}</span>
                <div class="step-info">
                    <div class="step-title">Anti-Skills</div>
                    <div class="step-description">Cosa NON fai</div>
                </div>
            </li>
            <li class="step-item {% if step == 4 %}active{% elif step > 4 %}completed{% else %}pending{% endif %}">
                <span class="step-number">{% if step > 4 %}âœ“{% else %}4{% endif %}</span>
                <div class="step-info">
                    <div class="step-title">Failure Museum</div>
                    <div class="step-description">I fallimenti</div>
                </div>
            </li>
            <li class="step-item {% if step == 5 %}active{% elif step > 5 %}completed{% else %}pending{% endif %}">
                <span class="step-number">{% if step > 5 %}âœ“{% else %}5{% endif %}</span>
                <div class="step-info">
                    <div class="step-title">Human Delta</div>
                    <div class="step-description">Tu vs AI</div>
                </div>
            </li>
            <li class="step-item {% if step == 6 %}active{% elif step > 6 %}completed{% else %}pending{% endif %}">
                <span class="step-number">{% if step > 6 %}âœ“{% else %}6{% endif %}</span>
                <div class="step-info">
                    <div class="step-title">Curiosity Stack</div>
                    <div class="step-description">Fonti di ispirazione</div>
                </div>
            </li>
            <li class="step-item {% if step == 7 %}active{% elif step > 7 %}completed{% else %}pending{% endif %}">
                <span class="step-number">{% if step > 7 %}âœ“{% else %}7{% endif %}</span>
                <div class="step-info">
                    <div class="step-title">Human API</div>
                    <div class="step-description">Manuale d'uso</div>
                </div>
            </li>
            <li class="step-item {% if step == 8 %}active{% elif step > 8 %}completed{% else %}pending{% endif %}">
                <span class="step-number">{% if step > 8 %}âœ“{% else %}8{% endif %}</span>
                <div class="step-info">
                    <div class="step-title">What's Next</div>
                    <div class="step-description">Obiettivi futuri</div>
                </div>
            </li>
            <li class="step-item {% if step == 9 %}active{% elif step > 9 %}completed{% else %}pending{% endif %}">
                <span class="step-number">{% if step > 9 %}âœ“{% else %}9{% endif %}</span>
                <div class="step-info">
                    <div class="step-title">Immagini</div>
                    <div class="step-description">Gallery personale</div>
                </div>
            </li>
            <li class="step-item {% if step == 10 %}active{% else %}pending{% endif %}">
                <span class="step-number">10</span>
                <div class="step-info">
                    <div class="step-title">Generazione</div>
                    <div class="step-description">Creazione finale</div>
                </div>
            </li>
        </ul>
    </aside>

    <!-- Step Content -->
    <div class="step-content">

    {% if step == 1 %}
    <!-- Step 1: Chi Sei -->
    <h2 class="step-header">ğŸ“‹ Step 1: Chi Sei</h2>

    <div class="encouragement-box">
        <h4>âœ¨ Prima di iniziare...</h4>
        <p>Ci vorrÃ  pazienza ma ne varrÃ  la pena. I recruiter potranno chattare col tuo profilo.</p>
        <p style="margin-top: 1rem; padding: 0.75rem; background: rgba(99, 102, 241, 0.1); border-left: 3px solid var(--primary); border-radius: 4px; font-size: 0.9rem;">
            â­ï¸ <strong>Ricorda:</strong> Tutte le domande sono facoltative! Puoi skippare e andare avanti. PiÃ¹ rispondi, migliore sarÃ  il risultato.
        </p>
    </div>

    <form hx-post="/create/step/1" hx-target=".creation-layout" hx-swap="outerHTML" enctype="multipart/form-data">
        <div class="form-row">
            <div class="form-group">
                <label for="nome">Nome *</label>
                <input type="text" name="nome" id="nome" required value="{{ data.get('nome', '') }}">
            </div>
            <div class="form-group">
                <label for="cognome">Cognome *</label>
                <input type="text" name="cognome" id="cognome" required value="{{ data.get('cognome', '') }}">
            </div>
        </div>

        <!-- CV Section with 3 options -->
        <div class="form-group">
            <label>ğŸ“„ CV / Background *</label>
            <div class="cv-options" style="margin-top: 0.5rem;">
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="radio" name="cv_type" value="upload" onchange="toggleCVInput('upload')">
                        <span>Allega file (PDF/Word)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="radio" name="cv_type" value="link" onchange="toggleCVInput('link')">
                        <span>Link condiviso</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="radio" name="cv_type" value="text" checked onchange="toggleCVInput('text')">
                        <span>Incolla testo</span>
                    </label>
                </div>

                <div id="cv-upload" style="display: none;">
                    <input id="cv_file" type="file" name="cv_file" accept=".pdf,.doc,.docx"
                           style="padding: 0.5rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text); width: 100%;">
                    <p class="form-help">Formati supportati: PDF, Word (.doc, .docx)</p>
                </div>

                <div id="cv-link" style="display: none;">
                    <input id="cv_link" type="url" name="cv_link" placeholder="https://drive.google.com/... o OneDrive/Dropbox link"
                           style="width: 100%; padding: 0.75rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text);">
                    <p class="form-help">Link condiviso da Google Drive, OneDrive, Dropbox, ecc.</p>
                </div>

                <div id="cv-text" style="display: block;">
                    <!-- NOTA: niente required fisso qui, lo gestiamo via JS -->
                    <textarea id="cv_content" name="cv_content" rows="8"
                              placeholder="Incolla qui il testo del tuo CV o descrivi il tuo background professionale...">{{ data.get('cv_content', '') }}</textarea>
                </div>
            </div>
        </div>

        <!-- Links Section (Dynamic) -->
        <div class="form-group">
            <label>ğŸ”— Link professionali</label>
            <p class="form-help">Aggiungi LinkedIn, GitHub, Behance, Articoli, Portfolio, ecc.</p>

            <div id="links-container">
                <!-- Default 2 rows -->
                <div class="link-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <input type="url" name="link_url[]" placeholder="https://linkedin.com/in/..."
                           style="flex: 2; padding: 0.75rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text);">
                    <select name="link_type[]"
                            style="flex: 1; padding: 0.75rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text);">
                        <option value="LinkedIn">LinkedIn</option>
                        <option value="GitHub">GitHub</option>
                        <option value="Behance">Behance</option>
                        <option value="Articolo">Articolo</option>
                        <option value="Altro">Altro</option>
                    </select>
                    <button type="button" onclick="removeLink(this)" class="btn-icon" style="padding: 0.75rem; background: var(--accent-red); color: white; border: none; border-radius: 8px; cursor: pointer;">âœ•</button>
                </div>

                <div class="link-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <input type="url" name="link_url[]" placeholder="https://github.com/..."
                           style="flex: 2; padding: 0.75rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text);">
                    <select name="link_type[]"
                            style="flex: 1; padding: 0.75rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text);">
                        <option value="LinkedIn">LinkedIn</option>
                        <option value="GitHub" selected>GitHub</option>
                        <option value="Behance">Behance</option>
                        <option value="Articolo">Articolo</option>
                        <option value="Altro">Altro</option>
                    </select>
                    <button type="button" onclick="removeLink(this)" class="btn-icon" style="padding: 0.75rem; background: var(--accent-red); color: white; border: none; border-radius: 8px; cursor: pointer;">âœ•</button>
                </div>
            </div>

            <button type="button" onclick="addLink()" class="btn btn-secondary" style="margin-top: 0.5rem;">
                â• Aggiungi link
            </button>
        </div>

        <div class="form-group">
            <label for="superpotere">âš¡ Superpotere</label>
            <p class="form-help">Se i tuoi amici o i tuoi colleghi ti definissero un supereroe, quale sarebbe il tuo superpotere?</p>
            <textarea name="superpotere" id="superpotere" rows="3"
                      placeholder='Es: "Sono quello che trova il bug impossibile" oppure "Riesco a semplificare idee complesse"'>{{ data.get('superpotere', '') }}</textarea>
        </div>

        <div class="form-group">
            <label for="presentazione">ğŸ’¬ Presentazione</label>
            <textarea name="presentazione" id="presentazione" rows="3">{{ data.get('presentazione', '') }}</textarea>
        </div>

        <div class="form-actions">
            <a href="/" class="btn btn-secondary">â† Home</a>
            <button type="submit" class="btn btn-primary">Avanti â†’</button>
        </div>
    </form>

    <script>
    function toggleCVInput(type) {
        const uploadBox = document.getElementById('cv-upload');
        const linkBox   = document.getElementById('cv-link');
        const textBox   = document.getElementById('cv-text');

        const fileEl = document.getElementById('cv_file');
        const linkEl = document.getElementById('cv_link');
        const textEl = document.getElementById('cv_content');

        // show/hide
        uploadBox.style.display = type === 'upload' ? 'block' : 'none';
        linkBox.style.display   = type === 'link'   ? 'block' : 'none';
        textBox.style.display   = type === 'text'   ? 'block' : 'none';

        // required SOLO sul selezionato
        fileEl.required = (type === 'upload');
        linkEl.required = (type === 'link');
        textEl.required = (type === 'text');

        // disabilita gli altri: cosÃ¬ non vengono validati e non vengono inviati
        fileEl.disabled = (type !== 'upload');
        linkEl.disabled = (type !== 'link');
        textEl.disabled = (type !== 'text');
    }

    // Inizializza in base al radio giÃ  checked (di default "text")
    document.addEventListener('DOMContentLoaded', () => {
        const checked = document.querySelector('input[name="cv_type"]:checked');
        toggleCVInput(checked ? checked.value : 'text');
    });

    function addLink() {
        const container = document.getElementById('links-container');
        const newRow = document.createElement('div');
        newRow.className = 'link-row';
        newRow.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
        newRow.innerHTML = `
            <input type="url" name="link_url[]" placeholder="https://..."
                   style="flex: 2; padding: 0.75rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text);">
            <select name="link_type[]"
                    style="flex: 1; padding: 0.75rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text);">
                <option value="LinkedIn">LinkedIn</option>
                <option value="GitHub">GitHub</option>
                <option value="Behance">Behance</option>
                <option value="Articolo">Articolo</option>
                <option value="Altro">Altro</option>
            </select>
            <button type="button" onclick="removeLink(this)" class="btn-icon" style="padding: 0.75rem; background: var(--accent-red); color: white; border: none; border-radius: 8px; cursor: pointer;">âœ•</button>
        `;
        container.appendChild(newRow);
    }

    function removeLink(button) {
        button.parentElement.remove();
    }
    </script>

    {% elif step == 2 %}
    <!-- Step 2: Decision Log -->
    <h2 class="step-header">ğŸŒ³ Step 2: Decision Log</h2>

    <form hx-post="/create/step/2" hx-target=".creation-layout" hx-swap="outerHTML">
        <div class="form-group">
            <label for="against_data">ğŸ¯ Decisione Contro Corrente</label>
            <p class="form-help">L'ultima volta che sei andato CONTRO i dati o il team</p>
            <textarea name="against_data" id="against_data" rows="6" placeholder="Es: 'Tutti i dati dicevano di fare X, ma io ho scelto Y perchÃ©...'">{{ data.get('against_data', '') }}</textarea>
        </div>

        <div class="form-group">
            <label for="project_desc">ğŸ“– Progetto con Biforcazione</label>
            <p class="form-help">Descrivi un progetto dove hai dovuto scegliere tra opzioni contrastanti</p>
            <textarea name="project_desc" id="project_desc" rows="6" placeholder="Es: 'Nel progetto X dovevo decidere tra approccio A (veloce ma rischioso) e approccio B (lento ma sicuro)...'">{{ data.get('project_desc', '') }}</textarea>
        </div>

        <div class="form-group">
            <label for="worst_decision">ğŸ’€ Peggior Decisione</label>
            <p class="form-help">Qual Ã¨ stata la tua peggior decisione professionale?</p>
            <textarea name="worst_decision" id="worst_decision" rows="4" placeholder="Es: 'Ho scelto di ignorare i warning del team su...'">{{ data.get('worst_decision', '') }}</textarea>
        </div>

        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="goBackStep(1)">â† Indietro</button>
            <button type="submit" class="btn btn-primary">Avanti â†’</button>
        </div>
    </form>

    {% elif step == 3 %}
    <!-- Step 3: Anti-Skills -->
    <h2 class="step-header">ğŸš« Step 3: Anti-Skills</h2>

    <form hx-post="/create/step/3" hx-target=".creation-layout" hx-swap="outerHTML">
        <div class="form-group">
            <label for="heresy">ğŸ”¥ Eresia Professionale</label>
            <p class="form-help">Qual Ã¨ un'opinione controversa che hai nel tuo campo?</p>
            <textarea name="heresy" id="heresy" rows="5" placeholder="Es: 'Penso che le metodologie agile siano sopravvalutate' oppure 'Credo che documentare troppo sia controproducente'">{{ data.get('heresy', '') }}</textarea>
        </div>

        <div class="form-group">
            <label for="anti_skills">ğŸš« Cosa NON Fai</label>
            <p class="form-help">Cosa scegli deliberatamente di NON fare?</p>
            <textarea name="anti_skills" id="anti_skills" rows="5" placeholder="Es: 'Non faccio riunioni dopo le 17:00' oppure 'Non lavoro su progetti senza una chiara visione strategica'">{{ data.get('anti_skills', '') }}</textarea>
        </div>

        <div class="form-group">
            <label for="red_flags">ğŸš© Red Flags</label>
            <p class="form-help">Quali red flags ti fanno scappare da un progetto o collaborazione?</p>
            <textarea name="red_flags" id="red_flags" rows="4" placeholder="Es: 'Requisiti che cambiano continuamente', 'Mancanza di ownership', 'Micromanagement eccessivo'">{{ data.get('red_flags', '') }}</textarea>
        </div>

        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="goBackStep(2)">â† Indietro</button>
            <button type="submit" class="btn btn-primary">Avanti â†’</button>
        </div>
    </form>

    {% elif step == 4 %}
    <!-- Step 4: Failure Museum -->
    <h2 class="step-header">ğŸ’€ Step 4: Failure Museum</h2>

    <form hx-post="/create/step/4" hx-target=".creation-layout" hx-swap="outerHTML">
        <div class="form-group">
            <label for="biggest_failure">ğŸ’¥ Fallimento Vero</label>
            <p class="form-help">Racconta un fallimento autentico, non un "punto debole camuffato"</p>
            <textarea name="biggest_failure" id="biggest_failure" rows="6" placeholder="Es: 'Ho lanciato una feature che nessuno ha usato perchÃ© non avevo fatto abbastanza ricerca utenti' oppure 'Ho gestito male un conflitto nel team e una persona di valore se ne Ã¨ andata'">{{ data.get('biggest_failure', '') }}</textarea>
        </div>

        <div class="form-group">
            <label for="pattern_failure">ğŸ”„ Pattern di Errore</label>
            <p class="form-help">C'Ã¨ un errore che tendi a ripetere?</p>
            <textarea name="pattern_failure" id="pattern_failure" rows="4" placeholder="Es: 'Tendo a sottovalutare i tempi necessari per completare i task' oppure 'Mi butto nel codice prima di pensare all'architettura'">{{ data.get('pattern_failure', '') }}</textarea>
        </div>

        <div class="form-group">
            <label for="belief_murdered">ğŸ’” Credenza Assassinata</label>
            <p class="form-help">Qual Ã¨ una convinzione professionale che hai dovuto abbandonare?</p>
            <textarea name="belief_murdered" id="belief_murdered" rows="4" placeholder="Es: 'Credevo che il codice perfetto fosse la cosa piÃ¹ importante, poi ho capito che consegnare valore Ã¨ prioritario' oppure 'Pensavo che lavorare piÃ¹ ore significasse essere piÃ¹ produttivi'">{{ data.get('belief_murdered', '') }}</textarea>
        </div>

        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="goBackStep(3)">â† Indietro</button>
            <button type="submit" class="btn btn-primary">Avanti â†’</button>
        </div>
    </form>

    {% elif step == 5 %}
    <!-- Step 5: Human Delta -->
    <h2 class="step-header">ğŸ¤– Step 5: Human Delta</h2>

    <form hx-post="/create/step/5" hx-target=".creation-layout" hx-swap="outerHTML">
        <div class="form-row">
            <div class="form-group">
                <label for="ai_guilty">ğŸ˜… Per quali task usi l'AI e ti vergogni un po' ad ammetterlo?</label>
                <textarea name="ai_guilty" id="ai_guilty" rows="4" placeholder="Es: 'Scrivo email formali', 'Genero idee per brainstorming', ecc.">{{ data.get('ai_guilty', '') }}</textarea>
            </div>
            <div class="form-group">
                <label for="ai_never">ğŸš« Per quali invece non la useresti MAI?</label>
                <textarea name="ai_never" id="ai_never" rows="4" placeholder="Es: 'Decisioni strategiche importanti', 'Feedback delicati al team', ecc.">{{ data.get('ai_never', '') }}</textarea>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="ai_better">ğŸ¤– C'Ã¨ qualcosa che l'AI fa MEGLIO di te?</label>
                <textarea name="ai_better" id="ai_better" rows="4" placeholder="Es: 'Analizzare grandi quantitÃ  di dati', 'Generare varianti creative', ecc.">{{ data.get('ai_better', '') }}</textarea>
            </div>
            <div class="form-group">
                <label for="human_better">ğŸ§  E qualcosa che tu fai meglio dell'AI (con prove concrete)?</label>
                <textarea name="human_better" id="human_better" rows="4" placeholder="Es: 'Capire le dinamiche del team', 'Negoziare compromessi complessi', con esempi concreti">{{ data.get('human_better', '') }}</textarea>
            </div>
        </div>

        <div class="form-group">
            <label for="delta_story">ğŸ“– Storia Delta</label>
            <p class="form-help">Racconta un momento in cui la tua collaborazione con l'AI ha prodotto qualcosa di inaspettato o particolarmente brillante</p>
            <textarea name="delta_story" id="delta_story" rows="5" placeholder="Es: 'Stavo cercando di risolvere X, l'AI mi ha suggerito Y, e insieme abbiamo scoperto Z...'">{{ data.get('delta_story', '') }}</textarea>
        </div>

        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="goBackStep(4)">â† Indietro</button>
            <button type="submit" class="btn btn-primary">Avanti â†’</button>
        </div>
    </form>

    {% elif step == 6 %}
    <!-- Step 6: Curiosity Stack -->
    <h2 class="step-header">ğŸ“š Step 6: Curiosity Stack</h2>

    <form hx-post="/create/step/6" hx-target=".creation-layout" hx-swap="outerHTML">
        <div class="form-group">
            <label for="masterclass">ğŸ“ Masterclass Non-Lavorativa</label>
            <p class="form-help">Se dovessi tenere una masterclass su qualcosa di NON legato al tuo lavoro, su cosa sarebbe?</p>
            <textarea name="masterclass" id="masterclass" rows="5" placeholder="Es: 'Come preparare il caffÃ¨ perfetto con la moka' oppure 'Storia della musica elettronica anni '90' oppure 'Giardinaggio urbano in spazi ridotti'">{{ data.get('masterclass', '') }}</textarea>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="books">ğŸ“š Libri formativi</label>
                <p class="form-help">Quali libri hanno influenzato il tuo modo di pensare/lavorare?</p>
                <textarea name="books" id="books" rows="4" placeholder="Es: 'Thinking, Fast and Slow di Kahneman', 'The Design of Everyday Things', ecc.">{{ data.get('books', '') }}</textarea>
            </div>
            <div class="form-group">
                <label for="people">ğŸ‘¤ Mentori</label>
                <p class="form-help">Chi sono le persone (vive o morte, reali o fittizie) che ti hanno ispirato?</p>
                <textarea name="people" id="people" rows="4" placeholder="Es: 'Richard Feynman per l'approccio alla curiositÃ ', 'Il mio primo manager che...'">{{ data.get('people', '') }}</textarea>
            </div>
        </div>

        <div class="form-group">
            <label for="rabbit_hole">ğŸ‡ Rabbit Hole Attuale</label>
            <p class="form-help">Qual Ã¨ la tua ossessione intellettuale del momento?</p>
            <textarea name="rabbit_hole" id="rabbit_hole" rows="4" placeholder="Es: 'Sto studiando i sistemi complessi e la teoria del caos' oppure 'Mi sono fissato con l'architettura brutalista'">{{ data.get('rabbit_hole', '') }}</textarea>
        </div>

        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="goBackStep(5)">â† Indietro</button>
            <button type="submit" class="btn btn-primary">Avanti â†’</button>
        </div>
    </form>

    {% elif step == 7 %}
    <!-- Step 7: Human API -->
    <h2 class="step-header">ğŸ§¬ Step 7: Human API</h2>

    <form hx-post="/create/step/7" hx-target=".creation-layout" hx-swap="outerHTML">
        <div class="form-group">
            <label for="communication">ğŸ’¬ Comunicazione</label>
            <p class="form-help">Come preferisci comunicare? (sincrono/asincrono, verbale/scritto, etc.)</p>
            <textarea name="communication" id="communication" rows="4" placeholder="Es: 'Preferisco comunicazione asincrona per decisioni importanti, sincrona per brainstorming' oppure 'Mi esprimo meglio per iscritto che a voce'">{{ data.get('communication', '') }}</textarea>
        </div>

        <div class="form-group">
            <label for="crash_triggers">ğŸ’¥ Crash Triggers</label>
            <p class="form-help">Cosa ti fa andare in tilt/frustrazione quando lavori?</p>
            <textarea name="crash_triggers" id="crash_triggers" rows="4" placeholder="Es: 'Interruzioni continue durante il deep work', 'Decisioni prese senza coinvolgermi', 'Mancanza di contesto prima di un task'">{{ data.get('crash_triggers', '') }}</textarea>
        </div>

        <div class="form-group">
            <label for="known_biases">âš ï¸ Bias Noti</label>
            <p class="form-help">Quali bias cognitivi sai di avere?</p>
            <textarea name="known_biases" id="known_biases" rows="4" placeholder="Es: 'Overconfidence - tendo a sottovalutare la complessitÃ ', 'Confirmation bias quando difendo le mie idee', 'Sunk cost fallacy - fatico ad abbandonare progetti in cui ho investito tempo'">{{ data.get('known_biases', '') }}</textarea>
        </div>

        <div class="form-group">
            <label for="ideal_conditions">âœ¨ Condizioni Ideali</label>
            <p class="form-help">In quali condizioni lavori al meglio? (ambiente, orari, team, autonomia, etc.)</p>
            <textarea name="ideal_conditions" id="ideal_conditions" rows="4" placeholder="Es: 'Mattina presto, in silenzio, con obiettivi chiari ma libertÃ  di metodo', 'Team piccolo, alta autonomia, feedback frequenti'">{{ data.get('ideal_conditions', '') }}</textarea>
        </div>

        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="goBackStep(6)">â† Indietro</button>
            <button type="submit" class="btn btn-primary">Avanti â†’</button>
        </div>
    </form>

    {% elif step == 8 %}
    <!-- Step 8: What's Next -->
    <h2 class="step-header">ğŸš€ Step 8: What's Next</h2>

    <form hx-post="/create/step/8" hx-target=".creation-layout" hx-swap="outerHTML">
        <div class="form-group">
            <label for="learning_next">ğŸ¯ Vuoi Imparare</label>
            <p class="form-help">Cosa vuoi imparare nei prossimi mesi?</p>
            <textarea name="learning_next" id="learning_next" rows="4" placeholder="Es: 'Voglio approfondire machine learning e NLP', 'Sto studiando system design per grandi scale', 'Mi interessa imparare Rust'">{{ data.get('learning_next', '') }}</textarea>
        </div>

        <div class="form-group">
            <label for="two_years">ğŸ”® Tra 2 Anni</label>
            <p class="form-help">Dove ti vedi professionalmente tra 2 anni?</p>
            <textarea name="two_years" id="two_years" rows="4" placeholder="Es: 'Voglio essere tech lead in un team di 5-10 persone', 'Lavorare su prodotti che impattano milioni di utenti', 'Avere lanciato il mio side project'">{{ data.get('two_years', '') }}</textarea>
        </div>

        <div class="form-group">
            <label for="dream_project">ğŸŒŸ Progetto dei Sogni</label>
            <p class="form-help">Qual Ã¨ il progetto che vorresti realizzare se avessi tempo/budget/risorse illimitate?</p>
            <textarea name="dream_project" id="dream_project" rows="4" placeholder="Es: 'Una piattaforma che democratizza l'accesso all'educazione', 'Un tool che risolve [problema specifico] nel mio settore', 'Un progetto open source che...'">{{ data.get('dream_project', '') }}</textarea>
        </div>

        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="goBackStep(7)">â† Indietro</button>
            <button type="submit" class="btn btn-primary">Avanti â†’</button>
        </div>
    </form>

    {% elif step == 9 %}
    <!-- Step 9: Immagini (Facoltativo) -->
    <h2 class="step-header">ğŸ–¼ï¸ Step 9: Immagini Personali</h2>
    <p class="step-subtitle" style="color: var(--text-muted); margin-bottom: 1.5rem;">
        Facoltativo: Aggiungi foto personali, hobby, viaggi, progetti per arricchire visivamente il tuo Noofolio.
    </p>

    <form hx-post="/create/step/9" hx-target=".creation-layout" hx-swap="outerHTML" enctype="multipart/form-data">
        <div class="form-group">
            <label>ğŸ“¸ Carica immagini (fino a 10)</label>
            <input type="file" name="images[]" multiple accept="image/*"
                   style="padding: 0.5rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text); width: 100%;">
            <p class="form-help">
                Aggiungi foto di te, dei tuoi progetti, hobby, viaggi, workspace, ecc.<br>
                Formati: JPG, PNG, WebP. Max 10 immagini.
            </p>
        </div>

        <div class="form-group">
            <label for="images_description">Descrizione immagini (facoltativo)</label>
            <textarea name="images_description" id="images_description" rows="3"
                      placeholder="Breve descrizione delle immagini caricate...">{{ data.get('images_description', '') }}</textarea>
        </div>

        <div class="encouragement-box">
            <h4>ğŸ’¡ Suggerimento</h4>
            <p>Le immagini renderanno il tuo Noofolio piÃ¹ personale e memorabile. Mostra chi sei oltre il lavoro!</p>
        </div>

        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="goBackStep(8)">â† Indietro</button>
            <button type="submit" class="btn btn-primary">ğŸš€ Genera Noofolio</button>
        </div>
    </form>

    {% elif step == 10 %}
    <!-- Step 10: Generation -->
    <h2 class="step-header">âœ¨ Generazione Noofolio</h2>

    <div id="generation-status" style="max-width: 600px; margin: 2rem auto;">
        <div class="progress-container" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 2rem;">
            <div class="progress-steps">
                <div class="progress-step" id="step-1" style="margin-bottom: 1rem; padding: 1rem; border-radius: 8px; background: rgba(99, 102, 241, 0.1);">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div class="spinner" style="width: 20px; height: 20px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <span id="step-1-text">â³ Preparazione...</span>
                    </div>
                </div>
                <div class="progress-step" id="step-2" style="margin-bottom: 1rem; padding: 1rem; border-radius: 8px; opacity: 0.5;">
                    <span id="step-2-text">ğŸ” Rilevamento archetipo...</span>
                </div>
                <div class="progress-step" id="step-3" style="margin-bottom: 1rem; padding: 1rem; border-radius: 8px; opacity: 0.5;">
                    <span id="step-3-text">ğŸ§© Estrazione pattern...</span>
                </div>
                <div class="progress-step" id="step-4" style="margin-bottom: 1rem; padding: 1rem; border-radius: 8px; opacity: 0.5;">
                    <span id="step-4-text">ğŸŒ³ Analisi decisioni...</span>
                </div>
                <div class="progress-step" id="step-5" style="margin-bottom: 1rem; padding: 1rem; border-radius: 8px; opacity: 0.5;">
                    <span id="step-5-text">âœï¸ Rilevamento firma...</span>
                </div>
                <div class="progress-step" id="step-6" style="margin-bottom: 1rem; padding: 1rem; border-radius: 8px; opacity: 0.5;">
                    <span id="step-6-text">ğŸ“– Composizione narrativa...</span>
                </div>
                <div class="progress-step" id="step-7" style="margin-bottom: 1rem; padding: 1rem; border-radius: 8px; opacity: 0.5;">
                    <span id="step-7-text">ğŸ¨ Generazione portfolio...</span>
                </div>
            </div>
        </div>

        <div class="form-actions" style="margin-top: 2rem;">
            <button type="button" class="btn btn-secondary" onclick="goBackStep(9)" id="back-button">â† Indietro</button>
        </div>
    </div>

    <style>
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    </style>

    <script>
    // Avvia automaticamente la generazione quando si carica lo step 10
    document.addEventListener('DOMContentLoaded', function() {
        const currentStep = {{ step }};
        if (currentStep === 10) {
            startGeneration();
        }
    });

    function startGeneration() {
        // Nascondi il pulsante indietro durante la generazione
        const backButton = document.getElementById('back-button');
        if (backButton) backButton.style.display = 'none';

        // Usa Server-Sent Events per il progresso in tempo reale
        const eventSource = new EventSource('/api/generate-stream');

        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);

            if (data.error) {
                document.getElementById('generation-status').innerHTML =
                    '<div class="error-box" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgb(239, 68, 68); padding: 1.5rem; border-radius: 8px;"><p>âŒ Errore: ' + data.error + '</p><button type="button" class="btn btn-secondary" onclick="goBackStep(9)" style="margin-top: 1rem;">â† Torna allo step precedente</button></div>';
                eventSource.close();
                return;
            }

            if (data.complete) {
                eventSource.close();
                // Redirect alla pagina dei risultati
                window.location.href = '/result/' + data.profile_id;
                return;
            }

            // Aggiorna lo step corrente
            const stepNum = data.step;
            const stepEl = document.getElementById('step-' + stepNum);
            const stepText = document.getElementById('step-' + stepNum + '-text');

            if (data.status === 'running') {
                stepEl.style.background = 'rgba(99, 102, 241, 0.1)';
                stepEl.style.opacity = '1';
                stepEl.innerHTML = '<div style="display: flex; align-items: center; gap: 1rem;"><div class="spinner" style="width: 20px; height: 20px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite;"></div><span>' + data.text + '</span></div>';
            } else if (data.status === 'done') {
                stepEl.style.background = 'rgba(34, 197, 94, 0.1)';
                stepEl.style.opacity = '1';
                stepEl.innerHTML = '<div style="display: flex; align-items: center; gap: 1rem;"><span style="color: var(--accent-green);">âœ…</span><span>' + data.text + '</span></div>';

                // Mostra l'archetipo se disponibile
                if (data.data && data.data.archetype_name) {
                    stepEl.innerHTML += '<div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(99, 102, 241, 0.05); border-radius: 4px; font-size: 0.9rem;"><strong>Archetipo rilevato:</strong> ' + data.data.archetype_name + '</div>';
                }
            }
        };

        eventSource.onerror = function(error) {
            console.error('EventSource error:', error);
            document.getElementById('generation-status').innerHTML =
                '<div class="error-box" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgb(239, 68, 68); padding: 1.5rem; border-radius: 8px;"><p>âŒ Errore di connessione. Riprova.</p><button type="button" class="btn btn-secondary" onclick="goBackStep(9)" style="margin-top: 1rem;">â† Torna allo step precedente</button></div>';
            eventSource.close();
        };
    }
    </script>

    {% endif %}

    </div><!-- end step-content -->
</div><!-- end creation-layout -->

<script>
// Salva i dati del form corrente in localStorage prima di cambiare step
function saveCurrentFormData() {
    const currentForm = document.querySelector('.step-content form');
    if (!currentForm) return;

    const formData = new FormData(currentForm);
    const currentStep = {{ step }};
    const data = {};

    for (let [key, value] of formData.entries()) {
        if (key.endsWith('[]')) {
            // Array fields (like links)
            if (!data[key]) data[key] = [];
            data[key].push(value);
        } else {
            data[key] = value;
        }
    }

    // Salva in localStorage
    const savedData = JSON.parse(localStorage.getItem('noofolio_temp_data') || '{}');
    savedData[`step_${currentStep}`] = data;
    localStorage.setItem('noofolio_temp_data', JSON.stringify(savedData));
}

// Funzione per tornare indietro
function goBackStep(targetStep) {
    // Salva i dati correnti prima di andare indietro
    saveCurrentFormData();

    // Salva lo step target
    sessionStorage.setItem('noofolio_go_to_step', targetStep);

    // Ricarica completamente la pagina /create
    // Questo forza il server a mostrare lo step 1 (o l'ultimo dalla sessione)
    window.location.href = '/create';
}

// Ripristina i dati salvati quando la pagina si carica
document.addEventListener('DOMContentLoaded', function() {
    const currentStep = {{ step }};
    const targetStep = sessionStorage.getItem('noofolio_go_to_step');

    // Se dobbiamo navigare a uno step specifico
    if (targetStep && parseInt(targetStep) !== currentStep) {
        const target = parseInt(targetStep);
        sessionStorage.removeItem('noofolio_go_to_step');

        // Per andare allo step N, devo fare POST allo step N-1
        // PerchÃ© il backend avanza automaticamente di uno step dopo il POST
        const stepToPost = target - 1;

        if (stepToPost >= 1) {
            // Crea e invia un form con i dati salvati per lo step precedente al target
            const savedData = JSON.parse(localStorage.getItem('noofolio_temp_data') || '{}');
            const stepData = savedData[`step_${stepToPost}`] || {};

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/create/step/${stepToPost}`;

            // Aggiungi tutti i campi salvati
            Object.keys(stepData).forEach(key => {
                const value = stepData[key];
                if (Array.isArray(value)) {
                    value.forEach(v => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = v || '';
                        form.appendChild(input);
                    });
                } else {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = value || '';
                    form.appendChild(input);
                }
            });

            document.body.appendChild(form);
            form.submit();
            return; // Esci qui per evitare di caricare i dati dello step corrente
        }
    }

    // Altrimenti ripristina i dati salvati per lo step corrente
    const savedData = JSON.parse(localStorage.getItem('noofolio_temp_data') || '{}');
    const stepData = savedData[`step_${currentStep}`];

    if (stepData) {
        // Riempi i campi del form con i dati salvati
        Object.keys(stepData).forEach(key => {
            const value = stepData[key];

            if (Array.isArray(value)) {
                // Gestisci array (come i link)
                const inputs = document.querySelectorAll(`[name="${key}"]`);
                inputs.forEach((input, index) => {
                    if (value[index]) input.value = value[index];
                });
            } else {
                const input = document.querySelector(`[name="${key}"]`);
                if (input) {
                    if (input.type === 'radio' || input.type === 'checkbox') {
                        input.checked = (input.value === value);
                    } else {
                        input.value = value;
                    }
                }
            }
        });
    }
});

// Salva i dati anche quando si va avanti (submit del form)
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('.step-content form');
    forms.forEach(form => {
        form.addEventListener('submit', function() {
            saveCurrentFormData();
        });
    });
});
</script>
{% endblock %}
