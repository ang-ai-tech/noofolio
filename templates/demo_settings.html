{% extends "base.html" %}

{% block content %}
<div class="section" style="max-width: 800px; margin: 2rem auto;">
    <h2 class="section-title">‚öôÔ∏è Configurazione Demo</h2>
    <p class="section-subtitle">‚úÖ Gestisci le tue API keys in modo sicuro</p>

    <div class="encouragement-box" style="margin-top: 2rem; background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(59, 130, 246, 0.1)); border-left: 3px solid var(--accent-green);">
        <h4>üîí Sicurezza</h4>
        <p><strong>Le API keys sono salvate solo nel backend (.env file)</strong></p>
        <p style="margin-top: 0.5rem; color: var(--text-dim); font-size: 0.9rem;">üí° Le chiavi non vengono mai esposte nel codice frontend e sono al sicuro su Git.</p>
    </div>

    <form id="settings-form" style="margin-top: 2rem;">
        <div class="form-group">
            <label for="provider">ü§ñ Provider LLM</label>
            <select name="provider" id="provider" onchange="updateProviderInfo()" style="width: 100%; padding: 0.75rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 1rem;">
                <option value="anthropic">Anthropic (Claude)</option>
                <option value="google">Google (Gemini)</option>
                <option value="openai">OpenAI (GPT-4)</option>
            </select>
        </div>

        <div class="form-group" style="margin-top: 1.5rem;">
            <label for="api_key">üîê API Key <span id="key-status"></span></label>
            <input type="password" name="api_key" id="api_key"
                   placeholder="Lascia vuoto per mantenere la chiave attuale"
                   style="width: 100%; padding: 0.75rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 1rem;">
            <p class="form-help" id="provider-help" style="margin-top: 0.5rem; color: var(--text-dim); font-size: 0.9rem;">
                Inserisci una nuova chiave solo se vuoi cambiarla
            </p>
        </div>

        <div class="form-group" style="margin-top: 1.5rem;">
            <label for="model">üéØ Modello</label>
            <input type="text" name="model" id="model"
                   placeholder="claude-sonnet-4-5-20250929"
                   style="width: 100%; padding: 0.75rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 1rem;">
            <p class="form-help" style="margin-top: 0.5rem; color: var(--text-dim); font-size: 0.9rem;">
                Modello LLM da utilizzare
            </p>
        </div>

        <!-- Current Settings Display -->
        <div id="current-settings" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-top: 2rem;">
            <h4 style="color: var(--accent); margin-bottom: 1rem;">üìä Configurazione Attuale</h4>
            <div style="color: var(--text-muted); font-size: 0.9rem;">
                <p><strong>Provider:</strong> <span id="current-provider">Caricamento...</span></p>
                <p><strong>Anthropic API Key:</strong> <span id="current-api-anthropic">Caricamento...</span></p>
                <p><strong>Google API Key:</strong> <span id="current-api-google">Caricamento...</span></p>
                <p><strong>OpenAI API Key:</strong> <span id="current-api-openai">Caricamento...</span></p>
            </div>
        </div>

        <div class="form-actions" style="margin-top: 2rem; display: flex; gap: 1rem;">
            <button type="submit" class="btn btn-primary" style="flex: 1;">üíæ Aggiorna Impostazioni</button>
            <button type="button" onclick="reloadSettings()" class="btn btn-secondary">üîÑ Ricarica</button>
        </div>
    </form>

    <div id="message" style="margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none;"></div>

    <!-- Info Box -->
    <div style="background: rgba(99, 102, 241, 0.1); border-left: 3px solid var(--primary); padding: 1.5rem; border-radius: 8px; margin-top: 2rem;">
        <h4 style="color: var(--primary-light); margin-bottom: 0.75rem;">‚ÑπÔ∏è Come Funziona</h4>
        <ul style="color: var(--text-muted); font-size: 0.9rem; line-height: 1.8; padding-left: 1.5rem;">
            <li><strong>Le API keys sono salvate in .env sul server</strong> - mai esposte nel browser</li>
            <li>Le chiavi vengono mascherate quando visualizzate (mostri solo gli ultimi 4 caratteri)</li>
            <li>Quando aggiorni una chiave, viene salvata nel file .env e applicata immediatamente</li>
            <li>Il provider viene salvato in config.yaml</li>
            <li><strong>Nessuna API key viene mai committata su Git</strong> (.env √® in .gitignore)</li>
        </ul>
    </div>

    <!-- Quick Links -->
    <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(59, 130, 246, 0.1)); border: 1px solid var(--accent-green); padding: 1.5rem; border-radius: 8px; margin-top: 2rem;">
        <h4 style="color: var(--accent-green); margin-bottom: 0.75rem;">üîó Ottieni API Keys Gratuite</h4>
        <p style="color: var(--text-muted); font-size: 0.9rem; line-height: 1.6;">
            <strong>Opzioni disponibili:</strong><br>
            ‚Ä¢ <a href="https://console.anthropic.com/" target="_blank" style="color: var(--primary-light);">Anthropic</a> - ‚Ç¨5 di credito gratuito (migliore qualit√†)<br>
            ‚Ä¢ <a href="https://makersuite.google.com/app/apikey" target="_blank" style="color: var(--primary-light);">Google Gemini</a> - 100% gratuito e illimitato ‚≠ê<br>
            ‚Ä¢ <a href="https://platform.openai.com/api-keys" target="_blank" style="color: var(--primary-light);">OpenAI</a> - Credito iniziale disponibile
        </p>
    </div>
</div>

<script>
// Load current settings on page load
document.addEventListener('DOMContentLoaded', function() {
    loadCurrentSettings();
});

async function loadCurrentSettings() {
    try {
        const response = await fetch('/api/settings/current');
        const data = await response.json();

        // Update provider
        document.getElementById('provider').value = data.provider;
        document.getElementById('current-provider').textContent = data.provider.charAt(0).toUpperCase() + data.provider.slice(1);

        // Update model placeholder
        document.getElementById('model').placeholder = data.models[data.provider] || '';

        // Update API key displays
        const anthropicKey = data.keys.anthropic;
        const googleKey = data.keys.google;
        const openaiKey = data.keys.openai;

        document.getElementById('current-api-anthropic').innerHTML = anthropicKey.configured 
            ? `‚úÖ Configurata - ${anthropicKey.masked}` 
            : '<span style="color: var(--accent-red);">‚ùå Non configurata</span>';

        document.getElementById('current-api-google').innerHTML = googleKey.configured 
            ? `‚úÖ Configurata - ${googleKey.masked}` 
            : '<span style="color: var(--accent-red);">‚ùå Non configurata</span>';

        document.getElementById('current-api-openai').innerHTML = openaiKey.configured 
            ? `‚úÖ Configurata - ${openaiKey.masked}` 
            : '<span style="color: var(--accent-red);">‚ùå Non configurata</span>';

        updateProviderInfo();

    } catch (error) {
        console.error('Error loading settings:', error);
        showMessage('‚ùå Errore nel caricamento delle impostazioni', 'error');
    }
}

function updateProviderInfo() {
    const provider = document.getElementById('provider').value;
    const helpText = document.getElementById('provider-help');

    const providerInfo = {
        'anthropic': 'üí° Claude Sonnet 4.5 - Migliore qualit√†, ‚Ç¨5 credito gratuito',
        'google': 'üéâ Gemini 2.0 Flash - Completamente gratuito e veloce',
        'openai': 'üí≥ GPT-4 - Ottima qualit√†, a pagamento dopo credito iniziale'
    };

    helpText.innerHTML = providerInfo[provider] || 'Seleziona un provider';
}

async function reloadSettings() {
    showMessage('üîÑ Ricaricamento...', 'info');
    await loadCurrentSettings();
    showMessage('‚úÖ Impostazioni ricaricate', 'success');
}

document.getElementById('settings-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const provider = document.getElementById('provider').value;
    const apiKey = document.getElementById('api_key').value.trim();
    const model = document.getElementById('model').value.trim();

    try {
        const response = await fetch('/api/settings/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                provider: provider,
                api_key: apiKey,
                model: model
            })
        });

        const data = await response.json();

        if (data.success) {
            showMessage('‚úÖ Impostazioni aggiornate con successo! Le modifiche sono attive.', 'success');
            // Clear API key input
            document.getElementById('api_key').value = '';
            // Reload to show updated values
            setTimeout(() => loadCurrentSettings(), 1000);
        } else {
            showMessage('‚ùå Errore: ' + data.error, 'error');
        }

    } catch (error) {
        console.error('Error updating settings:', error);
        showMessage('‚ùå Errore di connessione', 'error');
    }
});

function showMessage(text, type) {
    const messageDiv = document.getElementById('message');
    messageDiv.textContent = text;
    messageDiv.style.display = 'block';
    
    const colors = {
        'success': {bg: 'rgba(34, 197, 94, 0.2)', color: 'var(--accent-green)', border: 'var(--accent-green)'},
        'error': {bg: 'rgba(239, 68, 68, 0.2)', color: 'var(--accent-red)', border: 'var(--accent-red)'},
        'info': {bg: 'rgba(59, 130, 246, 0.2)', color: 'var(--primary)', border: 'var(--primary)'}
    };

    const style = colors[type] || colors.info;
    messageDiv.style.background = style.bg;
    messageDiv.style.color = style.color;
    messageDiv.style.border = `1px solid ${style.border}`;

    if (type !== 'info') {
        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, 5000);
    }
}
</script>
{% endblock %}