{% extends "base.html" %}

{% block content %}
<!-- Mind Sculptor Welcome Modal -->
<div id="mind-sculptor-modal" style="display: flex; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 3000; align-items: center; justify-content: center;">
    <div style="background: var(--bg-card); border: 2px solid var(--primary); border-radius: 20px; padding: 2.5rem; max-width: 600px; width: 90%; box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3);">
        <div style="text-align: center; margin-bottom: 2rem;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">üß†‚ú®</div>
            <h2 style="font-family: 'Playfair Display', serif; color: var(--primary-light); margin-bottom: 1rem; font-size: 2rem;">
                Ciao, bentornato!
            </h2>
            <p style="color: var(--text); font-size: 1.1rem; margin-bottom: 1.5rem;">
                Ti va di rispondere a un po' di domande casuali?
            </p>
        </div>

        <div style="background: rgba(99, 102, 241, 0.1); border-left: 3px solid var(--primary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <p style="color: var(--text); margin-bottom: 1rem;">
                <strong>Per fare ordine bisogna partire dal caos.</strong>
            </p>
            <p style="color: var(--text-muted); font-size: 0.95rem; margin-bottom: 1rem;">
                Pi√π domande fai ‚Äì anche scosse e apparentemente non utili ‚Äì pi√π il tuo Noofolio si adatter√† alla tua vera essenza.
            </p>
            <p style="color: var(--text-dim); font-size: 0.9rem; margin: 0;">
                üí° <em>Se rispondi bene alle domande, troverai un chatbot pi√π istruito su di te. I NooMe di persone che hanno risposto a tante domande hanno un punteggio di affidabilit√† pi√π alto.</em>
            </p>
        </div>

        <div style="display: flex; gap: 1rem; justify-content: center;">
            <a href="/mind-sculptor/{{ profile_id }}" class="btn btn-primary" style="padding: 1rem 2rem;">
                ‚ú® Inizia ora
            </a>
            <button onclick="closeModal()" class="btn btn-secondary" style="padding: 1rem 2rem;">
                üìã Pi√π tardi
            </button>
        </div>
    </div>
</div>

<div class="section">
    <h2 style="font-family: 'Playfair Display', serif; font-size: 2rem; color: #fff; margin-bottom: 0.5rem;">
        üëã Ciao, {{ name.split()[0] if name else 'User' }}!
    </h2>
    <p style="color: var(--text-muted); font-size: 1.1rem; margin-bottom: 2rem;">
        <em>{{ archetype.get('combo_display', '') }}</em>
    </p>
</div>

<div style="max-width: 1200px; margin: 0 auto;">
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
        <!-- Portfolio Preview -->
        <div>
            <h3 style="color: var(--text); margin-bottom: 1rem;">üìÑ Il tuo Noofolio</h3>
            <iframe srcdoc="{{ portfolio_html | replace('\"', '&quot;') }}" 
                    style="width: 100%; height: 600px; border: 1px solid var(--border); border-radius: 12px;">
            </iframe>
        </div>
        
        <!-- Actions -->
        <div>
            <h3 style="color: var(--text); margin-bottom: 1rem;">‚ö° Azioni</h3>
            
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <a href="/view/{{ profile_id }}" class="btn btn-primary" style="text-align: center;" title="Visualizza il tuo Noofolio completo come lo vedono gli altri">
                    üëÅÔ∏è Visualizza il mio Noofolio
                </a>

                <a href="/corrections/{{ profile_id }}" class="btn btn-secondary" style="text-align: center;" title="Aumenta la conoscenza del tuo MindMirror correggendo le risposte del chatbot. Le correzioni influenzano anche il Mind Sculptor.">
                    üéì Correggi il mio NooMe
                </a>

                <a href="/create" class="btn btn-secondary" style="text-align: center;" title="Rivedi e aggiorna le informazioni del tuo Noofolio">
                    ‚úèÔ∏è Rivedi il tuo Noofolio
                </a>

                <a href="/mind-sculptor/{{ profile_id }}" class="btn btn-secondary" style="text-align: center;" title="Generatore di domande casuali AI per migliorare il tuo profilo e rilevare potenziali cambiamenti">
                    üé≤ Mind-Sculptor
                </a>
            </div>
            
            <!-- Quick Stats -->
            <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-top: 2rem;">
                <h4 style="color: var(--accent); margin-bottom: 1rem;">üìä Stats</h4>
                <div style="color: var(--text-muted); font-size: 0.9rem;">
                    <p style="margin-bottom: 0.5rem;">
                        <strong style="color: var(--text);">Archetipo:</strong><br>
                        {{ archetype.get('archetype_name', 'N/A') }}
                    </p>
                    <p style="margin-bottom: 0.5rem;">
                        <strong style="color: var(--text);">Combo:</strong><br>
                        {{ archetype.get('combo', 'N/A') }}
                    </p>
                    <p style="margin: 0;">
                        <strong style="color: var(--text);">Tagline:</strong><br>
                        {{ archetype.get('tagline', 'N/A') }}
                    </p>
                </div>
            </div>

            <!-- My Archetype Manager -->
            <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-top: 1rem;">
                <h4 style="color: var(--accent); margin-bottom: 0.5rem;">üé® My Archetype Manager</h4>
                <p style="color: var(--text-dim); font-size: 0.85rem; margin-bottom: 1rem;">
                    L'archetipo viene individuato automaticamente dal sistema, ma puoi personalizzare alcuni aspetti visivi.
                </p>

                <!-- Info Box -->
                <div style="background: rgba(99, 102, 241, 0.1); border-left: 3px solid var(--primary); padding: 1rem; border-radius: 6px; margin-bottom: 1rem; font-size: 0.85rem;">
                    <p style="color: var(--text-muted); margin: 0;">
                        üí° <strong>Nota:</strong> Non puoi cambiare completamente l'archetipo assegnato. Usa il <strong>Mind Sculptor</strong> per modificare il tuo profilo psicologico e orientarti verso un altro stile.
                    </p>
                </div>

                <form id="archetype-customization-form" style="display: flex; flex-direction: column; gap: 1rem;">
                    <!-- Primary Color -->
                    <div>
                        <label for="primary-color" style="display: block; color: var(--text); font-size: 0.9rem; margin-bottom: 0.5rem;">
                            Colore Primario
                        </label>
                        <input type="color" id="primary-color" name="primary_color" value="#6366f1"
                               style="width: 100%; height: 40px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer;">
                    </div>

                    <!-- Font Family -->
                    <div>
                        <label for="font-family" style="display: block; color: var(--text); font-size: 0.9rem; margin-bottom: 0.5rem;">
                            Font Famiglia
                        </label>
                        <select id="font-family" name="font_family"
                                style="width: 100%; padding: 0.75rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                            <option value="Inter">Inter (Default)</option>
                            <option value="Playfair Display">Playfair Display (Serif)</option>
                            <option value="Roboto">Roboto (Sans-serif)</option>
                            <option value="Space Grotesk">Space Grotesk (Moderno)</option>
                            <option value="Libre Baskerville">Libre Baskerville (Elegante)</option>
                        </select>
                    </div>

                    <!-- Archetype Feedback -->
                    <div>
                        <label for="archetype-feedback" style="display: block; color: var(--text); font-size: 0.9rem; margin-bottom: 0.5rem;">
                            Feedback sull'Archetipo
                        </label>
                        <textarea id="archetype-feedback" name="archetype_feedback" rows="3"
                                  placeholder="Es: 'Mi sento pi√π vicino a un altro archetipo perch√©...' Il sistema ne terr√† conto nella prossima rigenerazione."
                                  style="width: 100%; padding: 0.75rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: 'Inter', sans-serif; resize: vertical;"></textarea>
                        <p style="color: var(--text-dim); font-size: 0.8rem; margin-top: 0.5rem; margin: 0;">
                            ‚ÑπÔ∏è Il feedback aiuter√† il sistema a orientarsi su un archetipo pi√π adatto nella prossima rigenerazione.
                        </p>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        üíæ Salva Personalizzazioni
                    </button>
                </form>

                <div id="customization-message" style="margin-top: 1rem; padding: 0.75rem; border-radius: 6px; display: none;"></div>
            </div>
            
            <!-- Downloads -->
            <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-top: 1rem;">
                <h4 style="color: var(--accent); margin-bottom: 1rem;">üì• Download</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
                    <a href="/download/html/{{ profile_id }}" class="btn btn-secondary" style="text-align: center; font-size: 0.85rem;">
                        HTML
                    </a>
                    <a href="/download/json/{{ profile_id }}" class="btn btn-secondary" style="text-align: center; font-size: 0.85rem;">
                        JSON
                    </a>
                    <a href="/export/pdf/{{ profile_id }}" class="btn btn-secondary" style="text-align: center; font-size: 0.85rem;">
                        PDF
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function closeModal() {
    document.getElementById('mind-sculptor-modal').style.display = 'none';
}

// Handle Archetype Customization Form
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('archetype-customization-form');
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = {
                primary_color: document.getElementById('primary-color').value,
                font_family: document.getElementById('font-family').value,
                archetype_feedback: document.getElementById('archetype-feedback').value
            };

            try {
                const response = await fetch('/api/archetype-customization/{{ profile_id }}', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                const messageDiv = document.getElementById('customization-message');

                if (data.success) {
                    messageDiv.textContent = '‚úÖ Personalizzazioni salvate con successo!';
                    messageDiv.style.display = 'block';
                    messageDiv.style.background = 'rgba(34, 197, 94, 0.2)';
                    messageDiv.style.color = 'var(--accent-green)';
                    messageDiv.style.border = '1px solid var(--accent-green)';
                } else {
                    messageDiv.textContent = '‚ùå Errore nel salvare le personalizzazioni: ' + (data.error || 'Errore sconosciuto');
                    messageDiv.style.display = 'block';
                    messageDiv.style.background = 'rgba(239, 68, 68, 0.2)';
                    messageDiv.style.color = 'var(--accent-red)';
                    messageDiv.style.border = '1px solid var(--accent-red)';
                }

                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            } catch (error) {
                const messageDiv = document.getElementById('customization-message');
                messageDiv.textContent = '‚ùå Errore di connessione: ' + error.message;
                messageDiv.style.display = 'block';
                messageDiv.style.background = 'rgba(239, 68, 68, 0.2)';
                messageDiv.style.color = 'var(--accent-red)';
                messageDiv.style.border = '1px solid var(--accent-red)';
            }
        });
    }
});
</script>
{% endblock %}